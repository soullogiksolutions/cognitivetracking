<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Forward Digit Span - Adaptive Audio Version</title>
  <script src="https://unpkg.com/jspsych@7.3.3/dist/jspsych.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3/dist/plugin-html-button-response.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3/dist/plugin-audio-keyboard-response.js"></script>
  <script src="https://unpkg.com/jspsych@7.3.3/dist/plugin-html-button-response.js"></script>
  <link href="https://unpkg.com/jspsych@7.3.3/dist/jspsych.css" rel="stylesheet" />
  <style>
    body { max-width: 600px; margin: 2em auto; font-family: Arial, sans-serif; }
    .num-button { font-size: 24px; width: 48px; height: 48px; margin: 4px; }
    #answer-display { min-height: 2em; font-size: 24px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body></body>

<script>
  document.addEventListener("DOMContentLoaded", function () {

    const jsPsych = initJsPsych({
      on_finish: () => jsPsych.data.displayData()
    });

    // Folder with digit audio files named one.wav ... nine.wav
    const audioFolder = "digits/";

    // Mapping digits to audio file names
    const digitAudioFiles = {
      1: "one.wav",
      2: "two.wav",
      3: "three.wav",
      4: "four.wav",
      5: "five.wav",
      6: "six.wav",
      7: "seven.wav",
      8: "eight.wav",
      9: "nine.wav"
    };

    // Parameters & state
    let maxTrials = 10;
    let currentSpan = 3;
    let maxSpanReached = 3;
    let trialNumber = 0;
    const maxMistakes = 3;
    let mistakes = 0;
    let currentDigits = [];
    let userResponse = [];

    // Preload audio files
    const preloadAudio = {
      type: "preload",
      audio: Object.values(digitAudioFiles).map(f => audioFolder + f)
    };

    // Start screen for parameters selection
    const startScreen = {
      type: "html-button-response",
      stimulus: `
        <h2>Forward Digit Span Task</h2>
        <p>You will hear sequences of digits played one by one.</p>
        <p>After the sequence, enter the digits you recall in the same order by clicking number buttons.</p>
        <p>The sequence length will adapt based on your performance.</p>
        <p>Select number of trials:</p>
        <input type="number" id="numTrials" value="${maxTrials}" min="3" max="50" style="font-size:18px; width: 80px;"><br><br>
        <p>Press Start to begin.</p>`,
      choices: ["Start"],
      on_load: () => {
        // Fix audio context resume on Chrome auto-play policies
        if (jsPsych.pluginAPI.audioContext()) {
          if (jsPsych.pluginAPI.audioContext().state === 'suspended') {
            jsPsych.pluginAPI.audioContext().resume();
          }
        }
      },
      on_finish: function (data) {
        const val = document.getElementById('numTrials').value;
        const parsed = parseInt(val);
        if (!isNaN(parsed) && parsed >= 3 && parsed <= 50) {
          maxTrials = parsed;
        }
      }
    };

    // Generate a random digit sequence of length n with digits from 1 to 9
    function generateDigits(n) {
      const digits = [];
      for (let i = 0; i < n; i++) {
        digits.push(Math.floor(Math.random() * 9) + 1);
      }
      return digits;
    }

    // Play digit audio files one by one in sequence
    // Returns timeline that plays each audio in stimList sequentially
    function playDigitsAudioTimeline(digitsList) {
      const timeline = digitsList.map(digit => ({
        type: "audio-keyboard-response",
        stimulus: audioFolder + digitAudioFiles[digit],
        choices: "NO_KEYS",
        trial_ends_after_audio: true,
        response_ends_trial: false,
        post_trial_gap: 300
      }));
      return timeline;
    }

    // UI for user to input recalled digits (click buttons)
    // Returns a trial that shows number buttons, displays user input, Submit & Clear buttons
    const userInputTrial = {
      type: "html-button-response",
      stimulus: function () {
        return `
          <p>Enter the digits you heard <b>in order</b> by clicking the buttons below:</p>
          <div id="num-buttons" style="margin-bottom:10px;">
            ${[1,2,3,4,5,6,7,8,9].map(n => `<button class="num-button" data-num="${n}">${n}</button>`).join('')}
          </div>
          <button id="clear-btn" style="font-size:16px; margin-right:15px;">Clear</button>
          <div><b>Your Answer:</b> <span id="answer-display"></span></div>
        `;
      },
      choices: ["Submit"],
      on_load: function () {
        userResponse = [];
        const answerDisplay = document.getElementById("answer-display");

        document.querySelectorAll(".num-button").forEach(btn => {
          btn.onclick = () => {
            const digit = btn.getAttribute("data-num");
            userResponse.push(Number(digit));
            answerDisplay.textContent = userResponse.join(" ");
          };
        });

        document.getElementById("clear-btn").onclick = () => {
          userResponse = [];
          answerDisplay.textContent = "";
        };
      },
      on_finish: function () {
        // Check correctness
        const correct = arraysEqual(userResponse, currentDigits);
        jsPsych.data.addDataToLastTrial({userResponse, correct, targetDigits: currentDigits, spanLength: currentSpan, trialNumber});
        if (correct) {
          currentSpan++;
          if(currentSpan > maxSpanReached) maxSpanReached = currentSpan;
        } else {
          mistakes++;
        }
        trialNumber++;
      }
    };

    function arraysEqual(a,b) {
      if (a.length !== b.length) return false;
      for(let i=0; i<a.length; i++) if (a[i] !== b[i]) return false;
      return true;
    }

    // Trial setup - generate digits and prepare timeline to play them
    function trialSetup() {
      currentDigits = generateDigits(currentSpan);
      return playDigitsAudioTimeline(currentDigits);
    }

    // Loop controlling the adaptive trials
    const adaptiveLoop = {
      timeline: [
        {
          timeline: trialSetup(),
          loop_function: function() { return false; }
        },
        userInputTrial
      ],
      loop_function: function() {
        // Stop if mistakes >= maxMistakes or trials reached maxTrials
        if (mistakes >= maxMistakes || trialNumber >= maxTrials) {
          return false;
        }
        return true;
      }
    };

    // Final screen summarizing results
    const finalScreen = {
      type: "html-button-response",
      stimulus: () => `
        <h2>Task Complete</h2>
        <p>Trials completed: ${trialNumber}</p>
        <p>Maximum digit span reached: ${maxSpanReached}</p>
        <p>Total mistakes: ${mistakes}</p>
        <p>Thank you for participating!</p>
      `,
      choices: ["Finish"]
    };

    // Run experiment timeline
    jsPsych.run([
      preloadAudio,
      startScreen,
      adaptiveLoop,
      finalScreen
    ]);
  });
</script>

</html>
