<html>
<head>
  <title>WM Digit Span with Researcher UI</title>
  <script src="jspsych-6.0.4/jspsych.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-survey-html-form.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-digit-span-recall.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
  <link href="jspsych-6.0.4/css/jspsych_digitspan.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>
<script>

// Global configuration variables with defaults
var nTrials = 14;
var minSetSize = 3;
var stimuli_duration = 1000;
var recall_duration = null;
var allow_export = true;

var possibleNumbers = ["1","2","3","4","5","6","7","8","9","0"];
var selection;
var selection_id = -1;
var nError = 0;
var highest_span_score = 0;
var consec_error_score = 0;

var partN = "unknown";
var IDsub = Date.now();

// Researcher form setup using survey-html-form plugin
var researcher_settings = {
  type: 'survey-html-form',
  html: `
    <p style="font-size:20px; font-weight:bold;">Configure WM Digit Span Test</p>
    
    <label for="nTrials">Number of Trials:</label><br>
    <input id="nTrials" name="nTrials" type="number" value="14" min="1" max="50" required><br><br>
    
    <label for="minSetSize">Minimum Digit Length:</label><br>
    <input id="minSetSize" name="minSetSize" type="number" value="3" min="1" max="10" required><br><br>
    
    <label for="stimuli_duration">Stimuli Display Duration (ms):</label><br>
    <input id="stimuli_duration" name="stimuli_duration" type="number" value="1000" min="100" max="5000" required><br><br>
    
    <label for="allow_export">Allow Data Export:</label><br>
    <select id="allow_export" name="allow_export" required>
      <option value="true" selected>Yes</option>
      <option value="false">No</option>
    </select><br><br>
  `,
  button_label: 'Start Experiment',
  on_finish: function(data){
    var responses = JSON.parse(data.responses);
    nTrials = parseInt(responses.nTrials);
    minSetSize = parseInt(responses.minSetSize);
    stimuli_duration = parseInt(responses.stimuli_duration);
    allow_export = responses.allow_export === "true";
    // Initialize selection based on minSetSize
    selection = jsPsych.randomization.sampleWithoutReplacement(possibleNumbers, minSetSize);
  }
};

// Participant ID collection (survey-text plugin used since you have it)
var p_details = {
  type: 'survey-text',
  questions: [{prompt: "Enter participant number, name, or ID"}],
  on_finish: function() {
    partN = jsPsych.data.get().last(1).values()[0].partNum;
    partN = partN.replace(/['"]+/g,'');
  }
};

// Instructions and other trials remain mostly the same
// ... (Use your existing instruction, stimulus, recall, feedback, and conclusion trials with minor adjustments to use new global variables)

// For brevity, only show conclusion with export button

var conclusion_html = function() {
  var html = `<div style="font-size:20px;">
    You have completed the task.<br>Thank you for your participation.<br><br>
    Maximum number of digits recalled correctly was ${highest_span_score}.<br><br>
    Maximum number of digits reached before two consecutive errors was ${consec_error_score}.<br><br>
    Please tell the Research Assistant you have completed the task.<br><br>`;
  if(allow_export){
    html += `<button id="exportBtn">Export Results (CSV)</button>`;
  }
  html += `</div>`;
  return html;
};

var conclusion = {
  type: 'html-keyboard-response',
  stimulus: conclusion_html,
  choices: jsPsych.ALL_KEYS,
  on_load: function(){
    if(allow_export){
      document.getElementById('exportBtn').addEventListener('click', function(){
        const data = jsPsych.data.get().csv();
        const filename = `WM_digit_span_${partN}_${IDsub}.csv`;
        const blob = new Blob([data], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      });
    }
  }
};

// Compose final timeline
var timeline = [];

timeline.push(researcher_settings);
timeline.push(p_details);

// Add your other experiment blocks here as in your original script:
// instructions, demo_procedure, instructions_node, test_procedure, fullscreen, etc.

// For now just add conclusion to demonstrate
timeline.push(conclusion);

jsPsych.init({
  timeline: timeline,
  on_finish: function(){
    jsPsych.data.displayData();
  }
});

</script>
</html>
