<html>
<head>
  <title>WM Digit Span with Researcher UI</title>
  <script src="jspsych-6.0.4/jspsych.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-digit-span-recall.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-survey-text.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
  <link href="jspsych-6.0.4/css/jspsych_digitspan.css" rel="stylesheet" type="text/css"></link>
</head>
<body></body>
<script>

// Global variables for experiment settings
var nTrials = 14;
var minSetSize = 3;
var stimuli_duration = 1000;
var recall_duration = null; // null = no limit
var allow_export = true;

var possibleNumbers = ["1","2","3","4","5","6","7","8","9","0"];
var selection;
var selection_id = -1;
var nError = 0;
var highest_span_score = 0;
var consec_error_score = 0;

var partN = "unknown";
var IDsub = Date.now();

// Researcher setup survey-text UI
var researcher_settings = {
  type: 'survey-text',
  questions: [
    {prompt: "Number of Trials (e.g. 14)", name: 'nTrials', required:true},
    {prompt: "Minimum Digit Length (e.g. 3)", name: 'minSetSize', required:true},
    {prompt: "Stimuli Display Duration (ms, e.g. 1000)", name: 'stimuli_duration', required:true},
    {prompt: "Allow data export? (true or false)", name: 'allow_export', required:true}    
  ],
  on_finish: function(data){
    var responses = JSON.parse(data.responses);
    nTrials = parseInt(responses.nTrials) || 14;
    minSetSize = parseInt(responses.minSetSize) || 3;
    stimuli_duration = parseInt(responses.stimuli_duration) || 1000;
    allow_export = responses.allow_export.toLowerCase() === "true";
    selection = jsPsych.randomization.sampleWithoutReplacement(possibleNumbers, minSetSize);
  }
};

// Participant ID collection
var p_details = {
  type:"survey-text",
  questions: [{prompt: "Enter participant number, name, or ID"}],
  on_finish:function(){
    partN = jsPsych.data.get().last(1).values()[0].partNum;
    partN = partN.replace(/['"]+/g,'');
  }
};

// Instructions
var instructions = {
  type: 'instructions',
  pages: [`
    <div style="font-size:20px;">
      <b>INSTRUCTIONS</b><br><br>
      This is the digit span task.<br><br>
      You will be shown a sequence of numbers one after the other.<br>
      Enter numbers in the exact order at the end of each trial.<br><br>
      Example: '7 4 5 1' means entering '7 4 5 1'.<br><br>
      Practice trials will start first.<br><br>
    </div>`
  ],
  allow_backward: false,
  button_label_next: "Next",
  show_clickable_nav: true
};

var instructions_node = {
  type: 'instructions',
  pages: [`
    <div style="font-size:20px;">
      You have completed the practice trials.<br><br>
      If you have questions, ask the researcher.<br>
      Otherwise, click 'Next' to proceed to the main trials.
    </div>
  `],
  allow_backward: false,
  button_label_next: "Next",
  show_clickable_nav: true,
  on_finish: function(){
    minSetSize = 3;
    selection = jsPsych.randomization.sampleWithoutReplacement(possibleNumbers, minSetSize);
  }
};

// Stimuli presentation
var test_stimuli = {
  type: 'html-keyboard-response',
  stimulus: function(){
    selection_id += 1;
    return '<div style="font-size:70px;">' + selection[selection_id] + '</div>';
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: stimuli_duration,
  on_finish: function(){
    if (selection_id + 1 >= selection.length){
      jsPsych.endCurrentTimeline();
    }
  }
};

// Recall
var recall = {
  type: 'digit-span-recall',
  correct_order: function(){
    return selection;
  },
  trial_duration: recall_duration,
  on_finish: function(){
    var acc = jsPsych.data.get().last(1).values()[0].accuracy;
    if (acc == 1){
      if (highest_span_score < minSetSize){
        highest_span_score = minSetSize;
      }
      minSetSize += 1;
      nError = 0;
    } else if (nError < 1) {
      nError += 1;
    } else {
      if (consec_error_score < minSetSize){
        consec_error_score = minSetSize;
      }
      minSetSize = Math.max(3, minSetSize - 1);
    }
    if (minSetSize <= 8){
      selection = jsPsych.randomization.sampleWithoutReplacement(possibleNumbers, minSetSize);
    } else {
      selection = jsPsych.randomization.sampleWithoutReplacement(possibleNumbers, 8);
      var extra = minSetSize - 8;
      var id = possibleNumbers.indexOf(selection[7]);
      possibleNumbers.splice(id, 1);
      var extraNumbers = jsPsych.randomization.sampleWithoutReplacement(possibleNumbers, extra);
      selection = selection.concat(extraNumbers);
      possibleNumbers = ["1","2","3","4","5","6","7","8","9","0"];
    }
    selection_id = -1;
  }
};

// Feedback trial
var feedback = {
  type: 'html-keyboard-response',
  stimulus: function(){
    var text = "";
    var accuracy = jsPsych.data.get().last(1).values()[0].accuracy;
    if (accuracy == 1){
      text += '<div style="font-size:35px; color:rgb(0 220 0);"><b>Correct</b></div>';
    } else {
      text += '<div style="font-size:35px; color:rgb(240 0 0);"><b>Incorrect</b></div>';
    }
    return text;
  },
  choices: jsPsych.NO_KEYS,
  trial_duration: 1000
};

// Conclusion with optional export button
var conclusion_html = function() {
  var html = `
    <div style="font-size:20px;">
      You have completed the task.<br>Thank you for your participation.<br><br>
      Maximum number of digits recalled correctly was ${highest_span_score}.<br><br>
      Maximum number of digits reached before two consecutive errors was ${consec_error_score}.<br><br>
      Please tell the Research Assistant you have completed the task.<br><br>
  `;
  if (allow_export) {
    html += `<button id="exportBtn">Export Results (CSV)</button>`;
  }
  html += `</div>`;
  return html;
};

var conclusion = {
  type: 'html-keyboard-response',
  stimulus: conclusion_html,
  choices: jsPsych.ALL_KEYS,
  on_load: function(){
    if(allow_export) {
      document.getElementById('exportBtn').addEventListener('click', function(){
        const data = jsPsych.data.get().csv();
        const filename = `WM_digit_span_${partN}_${IDsub}.csv`;
        const blob = new Blob([data], {type: 'text/csv'});
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      });
    }
  }
};

// Timelines for test and practice
var test_stack = {
  timeline: [test_stimuli],
  repetitions: 17
};

var test_procedure = {
  timeline: [test_stack, recall, feedback],
  repetitions: nTrials
};

var demo_procedure = {
  timeline: [test_stack, recall, feedback],
  repetitions: 3
};

// Compose the general timeline
var timeline = [];

timeline.push(researcher_settings);
timeline.push(p_details);
timeline.push({ type: 'fullscreen', fullscreen_mode: true });
timeline.push(instructions);
timeline.push(demo_procedure);
timeline.push(instructions_node);
timeline.push(test_procedure);
timeline.push({ type: 'fullscreen', fullscreen_mode: false });
timeline.push(conclusion);

jsPsych.init({
  timeline: timeline,
  on_finish: function(){
    jsPsych.data.displayData(); // comment out if you don't want to display results
  }
});
</script>
</html>
